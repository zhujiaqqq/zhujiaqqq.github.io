<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Java Android Python Algorithm and Machine learning">
<meta property="og:type" content="website">
<meta property="og:title" content="Zhujiaqqq Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Zhujiaqqq Blog">
<meta property="og:description" content="Java Android Python Algorithm and Machine learning">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zhujiaqqq Blog">
<meta name="twitter:description" content="Java Android Python Algorithm and Machine learning">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Zhujiaqqq Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zhujiaqqq Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/22/FFmpeg抽取视频数据/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/22/FFmpeg抽取视频数据/" itemprop="url">FFmpeg抽取视频数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-22T20:44:11+08:00">
                2019-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/音视频/" itemprop="url" rel="index">
                    <span itemprop="name">音视频</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SPS/PPS在ffmpeg的codec-&gt;extradata中获取</p>
<ol>
<li><p>加载ffmpeg的日志模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span><br><span class="line">...</span><br><span class="line">av_log_set_level(AV_LOG_DEBUG);</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册所有编解码器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*register all formats and codec*/</span></span><br><span class="line">av_register_all();</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开视频文件并获取视频文件上下文</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AVFormatContext *fmt_ctx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*open input media file, and allocate format context*/</span></span><br><span class="line"><span class="keyword">if</span>((err_code = avformat_open_input(&amp;fmt_ctx, src_filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">	av_strerror(err_code, errors, <span class="number">1024</span>);</span><br><span class="line">	av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"Could not open source file: %s, %d(%s)\n"</span>,</span><br><span class="line">               src_filename,</span><br><span class="line">               err_code,</span><br><span class="line">               errors);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印视频详细信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*dump input information*/</span></span><br><span class="line">av_dump_format(fmt_ctx, <span class="number">0</span>, src_filename, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成一个空的数据包，用于接收视频包</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*initialize packet*/</span></span><br><span class="line">av_init_packet(&amp;pkt);</span><br><span class="line">pkt.data = <span class="literal">NULL</span>;</span><br><span class="line">pkt.size = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取视频流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*find best video stream*/</span></span><br><span class="line">video_stream_index = av_find_best_stream(fmt_ctx, AVMEDIA_TYPE_VIDEO, <span class="number">-1</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (video_stream_index &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Could not find %s stream in input file %s\n"</span>,  av_get_media_type_string(AVMEDIA_TYPE_VIDEO),src_filename);</span><br><span class="line">	<span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环读取视频流中的包，进行处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*read frames from media file*/</span></span><br><span class="line"><span class="keyword">while</span> (av_read_frame(fmt_ctx, &amp;pkt) &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pkt.stream_index == video_stream_index)</span><br><span class="line">&#123;</span><br><span class="line">   h264_mp4toannexb(fmt_ctx, &amp;pkt, dst_fd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//release pkt-&gt;data</span></span><br><span class="line">av_packet_unref(&amp;pkt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>对包进行处理，提取帧数据进行写文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h264_mp4toannexb</span><span class="params">(AVFormatContext *fmt_ctx, AVPacket *in, FILE *dst_fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    AVPacket *out = <span class="literal">NULL</span>;</span><br><span class="line">    AVPacket spspps_pkt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">uint8_t</span> unit_type;</span><br><span class="line">    <span class="keyword">int32_t</span> nal_size;</span><br><span class="line">    <span class="keyword">uint32_t</span> cumul_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf_end;</span><br><span class="line">    <span class="keyword">int</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, i;</span><br><span class="line"></span><br><span class="line">    out = av_packet_alloc();</span><br><span class="line"></span><br><span class="line">    buf = in-&gt;data;</span><br><span class="line">    buf_size = in-&gt;size;</span><br><span class="line">    buf_end = in-&gt;data + in-&gt;size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        <span class="keyword">if</span> (buf + <span class="number">4</span> <span class="comment">/*s-&gt;length_size*/</span> &gt; buf_end)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        <span class="comment">//一个AVPacket中存的可能是一帧也可能是多帧</span></span><br><span class="line">        <span class="comment">// nal_size是一个帧的具体大小，在帧的头部的前4个字节</span></span><br><span class="line">        <span class="keyword">for</span> (nal_size = <span class="number">0</span>, i = <span class="number">0</span>; i &lt; <span class="number">4</span> <span class="comment">/*s-&gt;length_size*/</span>; i++)</span><br><span class="line">            nal_size = (nal_size &lt;&lt; <span class="number">8</span>) | buf[i];</span><br><span class="line"></span><br><span class="line">        buf += <span class="number">4</span>; <span class="comment">/*s-&gt;length_size;*/</span></span><br><span class="line">        <span class="comment">//帧数据的第一个字节的后5位是这个帧的nal单元</span></span><br><span class="line">        <span class="comment">/* nal:     7 -&gt; sps</span></span><br><span class="line"><span class="comment">                    8 -&gt; pps</span></span><br><span class="line"><span class="comment">                    key frame -&gt; 5</span></span><br><span class="line"><span class="comment">                    normal frame -&gt; 1 */</span></span><br><span class="line">        unit_type = *buf &amp; <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nal_size &gt; buf_end - buf || nal_size &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        <span class="comment">/* prepend only to the first type 5 NAL unit of an IDR picture, if no sps/pps are already present */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="comment">/*s-&gt;new_idr &amp;&amp; */</span> unit_type == <span class="number">5</span> <span class="comment">/*&amp;&amp; !s-&gt;idr_sps_seen &amp;&amp; !s-&gt;idr_pps_seen*/</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 关键帧，需要获取sps/pps数据，并重新修改视频宽高比等参数</span></span><br><span class="line">            h264_extradata_to_annexb(fmt_ctx-&gt;streams[in-&gt;stream_index]-&gt;codec-&gt;extradata,</span><br><span class="line">                                     fmt_ctx-&gt;streams[in-&gt;stream_index]-&gt;codec-&gt;extradata_size,</span><br><span class="line">                                     &amp;spspps_pkt,</span><br><span class="line">                                     AV_INPUT_BUFFER_PADDING_SIZE);</span><br><span class="line">            <span class="comment">// 为数据增加特征码</span></span><br><span class="line">            <span class="keyword">if</span> ((ret = alloc_and_copy(out,</span><br><span class="line">                                      spspps_pkt.data, spspps_pkt.size,</span><br><span class="line">                                      buf, nal_size)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            <span class="comment">/*s-&gt;new_idr = 0;*/</span></span><br><span class="line">            <span class="comment">/* if only SPS has been seen, also insert PPS */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ret = alloc_and_copy(out, <span class="literal">NULL</span>, <span class="number">0</span>, buf, nal_size)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = fwrite(out-&gt;data, <span class="number">1</span>, out-&gt;size, dst_fd);</span><br><span class="line">        <span class="keyword">if</span> (len != out-&gt;size)</span><br><span class="line">        &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"warning, length of writed data isn't equal pkt.size(%d, %d)\n"</span>,</span><br><span class="line">                   len,</span><br><span class="line">                   out-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">        fflush(dst_fd);</span><br><span class="line"></span><br><span class="line">    next_nal:</span><br><span class="line">        buf += nal_size;</span><br><span class="line">        cumul_size += nal_size + <span class="number">4</span>; <span class="comment">//s-&gt;length_size;</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (cumul_size &lt; buf_size);</span><br><span class="line">fail:</span><br><span class="line">    av_packet_free(&amp;out);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<ol start="2">
<li><p>获取SPS/PPS数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h264_extradata_to_annexb</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *codec_extradata, <span class="keyword">const</span> <span class="keyword">int</span> codec_extradata_size, AVPacket *out_extradata, <span class="keyword">int</span> padding)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> unit_size;</span><br><span class="line">    <span class="keyword">uint64_t</span> total_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *out = <span class="literal">NULL</span>, unit_nb, sps_done = <span class="number">0</span>,</span><br><span class="line">            sps_seen = <span class="number">0</span>, pps_seen = <span class="number">0</span>, sps_offset = <span class="number">0</span>, pps_offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *extradata = codec_extradata + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint8_t</span> nalu_header[<span class="number">4</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> length_size = (*extradata++ &amp; <span class="number">0x3</span>) + <span class="number">1</span>; <span class="comment">// retrieve length coded size, 用于指示表示编码数据长度所需字节数</span></span><br><span class="line"></span><br><span class="line">    sps_offset = pps_offset = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* retrieve sps and pps unit(s) */</span></span><br><span class="line">    unit_nb = *extradata++ &amp; <span class="number">0x1f</span>; <span class="comment">/* number of sps unit(s) */</span></span><br><span class="line">    <span class="keyword">if</span> (!unit_nb)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> pps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sps_offset = <span class="number">0</span>;</span><br><span class="line">        sps_seen = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (unit_nb--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">        unit_size = AV_RB16(extradata);</span><br><span class="line">        total_size += unit_size + <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> (total_size &gt; INT_MAX - padding)</span><br><span class="line">        &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR,</span><br><span class="line">                   <span class="string">"Too big extradata size, corrupted stream or invalid MP4/AVCC bitstream\n"</span>);</span><br><span class="line">            av_free(out);</span><br><span class="line">            <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (extradata + <span class="number">2</span> + unit_size &gt; codec_extradata + codec_extradata_size)</span><br><span class="line">        &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Packet header is not contained in global extradata, "</span></span><br><span class="line">                                       <span class="string">"corrupted stream or invalid MP4/AVCC bitstream\n"</span>);</span><br><span class="line">            av_free(out);</span><br><span class="line">            <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((err = av_reallocp(&amp;out, total_size + padding)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        <span class="built_in">memcpy</span>(out + total_size - unit_size - <span class="number">4</span>, nalu_header, <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(out + total_size - unit_size, extradata + <span class="number">2</span>, unit_size);</span><br><span class="line">        extradata += <span class="number">2</span> + unit_size;</span><br><span class="line">    pps:</span><br><span class="line">        <span class="keyword">if</span> (!unit_nb &amp;&amp; !sps_done++)</span><br><span class="line">        &#123;</span><br><span class="line">            unit_nb = *extradata++; <span class="comment">/* number of pps unit(s) */</span></span><br><span class="line">            <span class="keyword">if</span> (unit_nb)</span><br><span class="line">            &#123;</span><br><span class="line">                pps_offset = total_size;</span><br><span class="line">                pps_seen = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (out)</span><br><span class="line">        <span class="built_in">memset</span>(out + total_size, <span class="number">0</span>, padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sps_seen)</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING,</span><br><span class="line">               <span class="string">"Warning: SPS NALU missing or invalid. "</span></span><br><span class="line">               <span class="string">"The resulting stream may not play.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pps_seen)</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING,</span><br><span class="line">               <span class="string">"Warning: PPS NALU missing or invalid. "</span></span><br><span class="line">               <span class="string">"The resulting stream may not play.\n"</span>);</span><br><span class="line"></span><br><span class="line">    out_extradata-&gt;data = out;</span><br><span class="line">    out_extradata-&gt;size = total_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> length_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>为每一帧数据增加特征码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_and_copy</span><span class="params">(AVPacket *out,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">uint8_t</span> *sps_pps, <span class="keyword">uint32_t</span> sps_pps_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">uint8_t</span> *in, <span class="keyword">uint32_t</span> in_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset = out-&gt;size;</span><br><span class="line">    <span class="keyword">uint8_t</span> nal_header_size = offset ? <span class="number">3</span> : <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    err = av_grow_packet(out, sps_pps_size + in_size + nal_header_size);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sps_pps)</span><br><span class="line">        <span class="built_in">memcpy</span>(out-&gt;data + offset, sps_pps, sps_pps_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(out-&gt;data + sps_pps_size + nal_header_size + offset, in, in_size);</span><br><span class="line">    <span class="keyword">if</span> (!offset)</span><br><span class="line">    &#123;</span><br><span class="line">        AV_WB32(out-&gt;data + sps_pps_size, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        (out-&gt;data + offset + sps_pps_size)[<span class="number">0</span>] =</span><br><span class="line">            (out-&gt;data + offset + sps_pps_size)[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        (out-&gt;data + offset + sps_pps_size)[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/05/如何对图片进行缓存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/05/如何对图片进行缓存/" itemprop="url">如何对图片进行缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-05T21:17:54+08:00">
                2019-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="设计缓存算法的时候需要考虑"><a href="#设计缓存算法的时候需要考虑" class="headerlink" title="设计缓存算法的时候需要考虑"></a>设计缓存算法的时候需要考虑</h3><ul>
<li>哪些应该保存</li>
<li>哪些应该丢弃</li>
<li>什么时候丢弃</li>
<li>获取数据的成本和缓存数据的成本</li>
<li>缓存价值（命中率）</li>
</ul>
<h4 id="LRU（Least-Recently-Used）算法的实现"><a href="#LRU（Least-Recently-Used）算法的实现" class="headerlink" title="LRU（Least Recently Used）算法的实现"></a>LRU（Least Recently Used）算法的实现</h4><ul>
<li>LRU内部包含一个LinkedHashMap</li>
<li>统计监控（额外的开销，可以监控算法的有效性）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> putCount;<span class="comment">//放入个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> createCount;<span class="comment">//创建个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> evictionCount;<span class="comment">//弹出个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> hitCount;<span class="comment">//命中个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> missCount;<span class="comment">//没命中个数</span></span><br></pre></td></tr></table></figure>
<h4 id="LFU（Least-Frequently-Used）"><a href="#LFU（Least-Frequently-Used）" class="headerlink" title="LFU（Least Frequently Used）"></a>LFU（Least Frequently Used）</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/如何避免OOM产生/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/如何避免OOM产生/" itemprop="url">如何避免OOM产生</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T22:36:42+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="OOM的产生"><a href="#OOM的产生" class="headerlink" title="OOM的产生"></a>OOM的产生</h3><ul>
<li>已使用内存+新申请内存&gt;可分配内存</li>
<li>OOM几乎覆盖所有的内存区域，通常指堆内存</li>
<li>Native Heap在物理内存不够时也会抛出OOM</li>
</ul>
<h3 id="使用合适的数据结构"><a href="#使用合适的数据结构" class="headerlink" title="使用合适的数据结构"></a>使用合适的数据结构</h3><ul>
<li>HashMap——大于1000个数、增删频繁</li>
<li>ArrayMap——key不是整型</li>
<li>SparseArray——Key是整型（池化技术、内存复用）</li>
</ul>
<h3 id="避免使用枚举"><a href="#避免使用枚举" class="headerlink" title="避免使用枚举"></a>避免使用枚举</h3><p>每一个枚举就是一个对象，对象至少占24字节。所以使用静态常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(value = RetentionPolicy.SOURCE)</span><br><span class="line"><span class="meta">@IntDef</span>(value = &#123;COMMON, LOAD_MORE, LOAD_REFRESH&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoadType &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMON = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_MORE = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_REFRESH = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>Kotlin 可以使用内联类，编译时转化为int，节省内存。</p>
<h3 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h3><ul>
<li><p>尽量根据实际需求选择合适的分辨率</p>
</li>
<li><p>不用帧动画，使用代码实现动效</p>
</li>
<li><p>使用Bitmap重采用和复用配置</p>
<h3 id="使用NDK"><a href="#使用NDK" class="headerlink" title="使用NDK"></a>使用NDK</h3></li>
<li><p>Native Heap没有专门的使用限制</p>
</li>
<li>内存大户的核心逻辑主要在Native 层</li>
</ul>
<h3 id="内存优化5R法则"><a href="#内存优化5R法则" class="headerlink" title="内存优化5R法则"></a>内存优化5R法则</h3><ul>
<li>Reduce缩减：降低图片分辨率/重采样/抽稀策略</li>
<li>Reuse复用：池化策略/避免频繁创建对象，减小GC压力</li>
<li>Recycle回收：主动销毁、结束，避免内存泄露/生命周期闭环</li>
<li>Refactor重构：更合适的数据结构/更合理的程序架构</li>
<li>Revalue重审：谨慎使用Large Heap/多进程/第三方框架</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/01/RxJava中CompositeDisposable注意事项/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/01/RxJava中CompositeDisposable注意事项/" itemprop="url">RxJava中CompositeDisposable注意事项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-01T16:14:39+08:00">
                2019-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在RxJava中，Observable被订阅后，可以得到一个Disposable对象。为了防止内存泄露，一般情况下，都会在Activity结束的时候调用Disposable对象的dispose()方法，解除订阅。</p>
<p>RxJava2中，提供了一个CompositeDisposable类作为Disposable的容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeDisposable</span> <span class="keyword">implements</span> <span class="title">Disposable</span>, <span class="title">DisposableContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    OpenHashSet&lt;Disposable&gt; resources;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> disposed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates an empty CompositeDisposable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CompositeDisposable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，CompositeDisposable实现了Disposable接口（void dispose();方法）；实现了DisposableContainer接口，可以add、remove、delete操作Disposable。</p>
<p>重点要关注两个方法：</p>
<p>1、<code>add(@NonNull Disposable d)</code>这个方法是将一个dispoable加入CompositeDisposable中，当Activity或者Fragment的生命周期结束的时候，通过</p>
<p>dispose()方法将Observable的订阅事件取消关联，防止内存泄露。</p>
<p>2、<code>public void dispose()</code>这个方法就是CompositeDisposable中将所有的Observable的订阅事件取消关联使用。</p>
<hr>
<p>之前遇到过一个问题：</p>
<blockquote>
<p>使用MVP模式开发的时候，Activity A的Presenter中包含CompositeDisposable对象，Activity A的onStart（）方法中关联了A的Presenter，当Activity A 跳转到Activity B的时候，我在A的onStop（）方法中调用了CompositeDisposable.dispose()方法。当Activity B 调用finish（）方法结束时候，回到Activity A页面，Activity A上的所有关于RxJava的调用都失效。</p>
</blockquote>
<p>我通过Debug的方式一层层的查看方法的调用栈对比正常的情况，最终发现：</p>
<p>CompositeDisposable的dispose()方法在被调用之后，所有的add()进来的Disposable都会直接调用自身的dispose()方法，也就是说在事件刚被绑定监听的时候就被解除绑定了。</p>
<p>查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    OpenHashSet&lt;Disposable&gt; set;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        disposed = <span class="keyword">true</span>;</span><br><span class="line">        set = resources;</span><br><span class="line">        resources = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dispose(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在dispose() 方法调用的时候，会将全局变量<code>disposed</code>置为true。</p>
<p>再看add方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(@NonNull Disposable d)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(d, <span class="string">"d is null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!disposed) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!disposed) &#123;</span><br><span class="line">                OpenHashSet&lt;Disposable&gt; set = resources;</span><br><span class="line">                <span class="keyword">if</span> (set == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    set = <span class="keyword">new</span> OpenHashSet&lt;Disposable&gt;();</span><br><span class="line">                    resources = set;</span><br><span class="line">                &#125;</span><br><span class="line">                set.add(d);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    d.dispose();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在add一个disposable的时候，如果全局变量disposed为true，那么不会走if条件，而是直接走下面的<code>d.dispose();</code>这句，直接将监听的事件解除绑定。</p>
<p><strong>所有，CompositeDisposable的dispose()方法一定要放到Activity和Fragment生命周期结束的地方——onDestroy()中。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/28/实现一个Handler-Looper框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/28/实现一个Handler-Looper框架/" itemprop="url">实现一个Handler-Looper框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-28T22:37:33+08:00">
                2019-08-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Handler的核心能力"><a href="#Handler的核心能力" class="headerlink" title="Handler的核心能力"></a>Handler的核心能力</h4><ul>
<li>线程间通信</li>
<li>延迟任务执行</li>
</ul>
<p><code>sendMessageDelayed(Message msg, long delay)</code></p>
<p><code>postDelayed(Runnable r, long delay)</code></p>
<h4 id="Looper的核心能力"><a href="#Looper的核心能力" class="headerlink" title="Looper的核心能力"></a>Looper的核心能力</h4><ul>
<li>Looper是线程特有的，所以要有ThreadLocal</li>
<li>包含MessageQueue</li>
<li><code>loop()</code>方法，在死循环中获取消息队列中的消息，分发给handler处理</li>
</ul>
<h4 id="MessageQueue的核心能力"><a href="#MessageQueue的核心能力" class="headerlink" title="MessageQueue的核心能力"></a>MessageQueue的核心能力</h4><ul>
<li>持有消息（链表）</li>
<li>消息按时间排序（优先队列）</li>
<li>队列为空的时候阻塞读取（阻塞队列）</li>
<li>头节点有延时可以定时阻塞（延时阻塞队列）</li>
</ul>
<p>使用DelayQueue</p>
<h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><p>仿造Android的message</p>
<hr>
<h3 id="类结构"><a href="#类结构" class="headerlink" title="类结构"></a>类结构</h3><p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20190828230220.png" alt></p>
<h3 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h3><ul>
<li><p>实现BlockingQueue接口（实现阻塞功能）</p>
</li>
<li><p>有PriorityQueue对象（可以优先排序）</p>
<p>DelayQueue的阻塞机制：通过condition.await方法</p>
</li>
</ul>
<h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><p>没有实现remove的方法</p>
<hr>
<h4 id="为什么Android不直接使用DelayQueue作为消息队列"><a href="#为什么Android不直接使用DelayQueue作为消息队列" class="headerlink" title="为什么Android不直接使用DelayQueue作为消息队列"></a>为什么Android不直接使用DelayQueue作为消息队列</h4><ul>
<li>DelayQueue没有提供合适的remove机制</li>
<li>更大的自由度，可以定制许多功能，特别是与Native层结合</li>
<li>Android的MessageQueue可以针对单线程读取的场景做优化，只有插入队列的时候加锁，而读取的时候不用加锁；DelayQueue读写都加锁</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/27/Android为什么非UI线程不能更新UI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/27/Android为什么非UI线程不能更新UI/" itemprop="url">Android为什么非UI线程不能更新UI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-27T15:52:08+08:00">
                2019-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="UI-线程的什么"><a href="#UI-线程的什么" class="headerlink" title="UI 线程的什么"></a>UI 线程的什么</h4><p>Zygote fork出的线程就是UI线程。</p>
<p>zygote创建App的过程中调用ActivityThread类的main()方法，main中会自行<code>Looper.loop();</code>。</p>
<h4 id="主线程如何工作"><a href="#主线程如何工作" class="headerlink" title="主线程如何工作"></a>主线程如何工作</h4><ul>
<li>handler </li>
<li>loop </li>
<li>messageQueue</li>
</ul>
<h4 id="如果把UI设计成线程安全的"><a href="#如果把UI设计成线程安全的" class="headerlink" title="如果把UI设计成线程安全的"></a>如果把UI设计成线程安全的</h4><p>那么需要对控件加锁，哪一个线程拿到锁才能设置UI。</p>
<h4 id="UI为什么不设计成线程安全的"><a href="#UI为什么不设计成线程安全的" class="headerlink" title="UI为什么不设计成线程安全的"></a>UI为什么不设计成线程安全的</h4><ul>
<li>UI具有可变性，甚至是高频可变性</li>
<li>UI对响应时间的敏感性要求UI操作必须高效</li>
<li>UI组件必须批量绘制来保证效率</li>
</ul>
<p><em>加锁可以变成线程安全，但是加锁是有性能开销的，会使UI的整体性能下降</em></p>
<h4 id="非UI线程一定不能更新UI吗"><a href="#非UI线程一定不能更新UI吗" class="headerlink" title="非UI线程一定不能更新UI吗"></a>非UI线程一定不能更新UI吗</h4><p>SurfaceView可以在非UI线程更新UI：</p>
<p>lockCanvas -&gt; draw -&gt; unLockCanvasAndPost </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/25/如何实现类似微信右滑返回的效果/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/25/如何实现类似微信右滑返回的效果/" itemprop="url">如何实现类似微信右滑返回的效果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-25T16:14:43+08:00">
                2019-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Fragment的实现"><a href="#Fragment的实现" class="headerlink" title="Fragment的实现"></a>Fragment的实现</h4><ul>
<li>对于Fragment的控制相对简单</li>
<li>不涉及window的控制，只是View级别的操作</li>
<li>实现View跟随手势滑动移动的效果</li>
<li>实现手势结束后判断取消或返回执行归位动画</li>
</ul>
<h4 id="Activity的实现"><a href="#Activity的实现" class="headerlink" title="Activity的实现"></a>Activity的实现</h4><ul>
<li><p>处理好window的控制</p>
<ul>
<li><p>修改activity的style属性：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTranslucentTheme"</span> <span class="attr">parent</span>=<span class="string">"AppTheme"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowBackground"</span>&gt;</span>@android:color/transparent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowIsTranslucent"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Activity联动（多个activity栈）</p>
<blockquote>
<p>Activity A和Activity C在Task#0</p>
</blockquote>
<p>  Activity B在Task#1</p>
<p>  当Activity A跳转Activity B时没有问题（有动画效果）</p>
<p>  再当Activity B跳转Activity C时，会先出现Activity A，然后动画效果到Activity C</p>
<p>处理方法：再Activity B跳转Activity C的时候将B页面整体截屏放到Activity C的下面。</p>
<p>获取Activity的栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Activity.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTaskId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ActivityManager.getService()</span><br><span class="line">            .getTaskForActivity(mToken, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Activity透明对生命周期的影响"><a href="#Activity透明对生命周期的影响" class="headerlink" title="Activity透明对生命周期的影响"></a>Activity透明对生命周期的影响</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">Created -- onStart --&gt; Started</span><br><span class="line">Started -- onResume --&gt; Resumed</span><br><span class="line">Resumed -- onPause --&gt;Started</span><br><span class="line">Started -- onStop --&gt; Created</span><br></pre></td></tr></table></figure>
<p>A、B、C、D四个Activity依次跳转，此时Activity栈中：A-&gt;B-&gt;C-&gt;D。（默认都不透明）</p>
<ul>
<li>如果D为不透明Activity，那么：D为Resumed状态（可操作），ABC为Created状态（不可见）。</li>
<li>如果D为透明Activity，那么：D为Resumed状态（可操作），C为Started状态（可见，不可操作），AB为Created状态（不可见）</li>
<li>如果C、D为透明Activity，那么：：D为Resumed状态（可操作），B、C为Started状态（可见，不可操作），A为Created状态（不可见）</li>
</ul>
<h4 id="实现滑动返回接口"><a href="#实现滑动返回接口" class="headerlink" title="实现滑动返回接口"></a>实现滑动返回接口</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/24/如何解决Activity参数的类型安全及接口繁琐的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/24/如何解决Activity参数的类型安全及接口繁琐的问题/" itemprop="url">如何解决Activity参数的类型安全及接口繁琐的问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-24T21:30:06+08:00">
                2019-08-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>类型安全：Bundle的K-V不能在编译期保证类型</li>
<li>接口繁琐：启动Activity 时参数和结果传递都依赖Intent</li>
</ul>
<h4 id="onActivityResult为什么麻烦"><a href="#onActivityResult为什么麻烦" class="headerlink" title="onActivityResult为什么麻烦"></a>onActivityResult为什么麻烦</h4><ol>
<li>代码处理逻辑分离，容易出现遗漏和不一致的问题</li>
<li><code>setResult（）</code>写法不够直观，结果数据没有类型安全保障</li>
<li>结果种类较多时，onActivityResult就会逐渐臃肿难以维护</li>
</ol>
<h4 id="为什么Activity的参数存在类型安全问题"><a href="#为什么Activity的参数存在类型安全问题" class="headerlink" title="为什么Activity的参数存在类型安全问题"></a>为什么Activity的参数存在类型安全问题</h4><p><code>intent.putExtra()</code>时和<code>getIntent.getXxxExtra()</code>时需要人工去保证类型安全</p>
<hr>
<h3 id="如何实现类型安全"><a href="#如何实现类型安全" class="headerlink" title="如何实现类型安全"></a>如何实现类型安全</h3><ul>
<li><p>注解处理器生成Builder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span></span>&#123;</span><br><span class="line">	<span class="meta">@Required</span></span><br><span class="line">	String name;</span><br><span class="line">	<span class="meta">@Required</span></span><br><span class="line">	<span class="keyword">int</span> age;</span><br><span class="line">	<span class="meta">@Optional</span></span><br><span class="line">	String title;</span><br><span class="line">	<span class="meta">@Optional</span></span><br><span class="line">	String company;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">UserActivityBuilder.builder(age, name)</span><br><span class="line">	.title(title)</span><br><span class="line">	.company(company);</span><br></pre></td></tr></table></figure>
<p>通过注解处理器生成注入逻辑</p>
</li>
</ul>
<h4 id="注解处理器程序的开发注意事项"><a href="#注解处理器程序的开发注意事项" class="headerlink" title="注解处理器程序的开发注意事项"></a>注解处理器程序的开发注意事项</h4><ul>
<li>注意注解标注的类的继承关系</li>
<li>注意注解标注的类为内部类的情况</li>
<li>注意kotlin与java的类型映射的问题</li>
<li>把握好代码生成和直接依赖的边界</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/24/如何跨App启动Activity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/24/如何跨App启动Activity/" itemprop="url">如何跨App启动Activity</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-24T20:38:54+08:00">
                2019-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">AppA的ActivityA -- 启动 --&gt; AppB的ActivityB</span><br></pre></td></tr></table></figure>
<ul>
<li><h4 id="共享uid的App"><a href="#共享uid的App" class="headerlink" title="共享uid的App"></a>共享uid的App</h4></li>
</ul>
<p>在AndroidManifest中：<code>manifest</code>标签中添加<code>android:sharedUserId=&quot;xxxx&quot;</code></p>
<p>启动时：<code>startActivity(new Intent().setComponent(new ComponentName(&quot;com.example.zhu&quot;,&quot;com.example.zhu.XxxActivity&quot;)));</code></p>
<ul>
<li><h4 id="使用exported"><a href="#使用exported" class="headerlink" title="使用exported"></a>使用exported</h4></li>
</ul>
<p>在Manifest中添加exported属性<code>&lt;activity android:name=&quot;.BActivity&quot; android:exported=&quot;true&quot;/&gt;</code></p>
<p>启动时：<code>startActivity(new Intent().setComponent(new ComponentName(&quot;com.example.zhu&quot;,&quot;com.example.zhu.XxxActivity&quot;)));</code></p>
<ul>
<li><h4 id="使用intentFilter-隐式跳转"><a href="#使用intentFilter-隐式跳转" class="headerlink" title="使用intentFilter(隐式跳转)"></a>使用intentFilter(隐式跳转)</h4></li>
</ul>
<p>在Manifest的Activity标签中添加：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.TEST"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动时：<code>startActivity(new Intent(&quot;android.intent.action.TEST&quot;))</code></p>
<hr>
<h4 id="Activity加权限"><a href="#Activity加权限" class="headerlink" title="Activity加权限"></a>Activity加权限</h4><ol>
<li><p>给AppA的manifest中添加权限：</p>
<p><code>&lt;uses-permission android:name=&quot;com.example.zhu&quot;/&gt;</code></p>
</li>
<li><p>gei AppB中需要启动的Activity添加permission属性：</p>
<p><code>android:permission=&quot;com.example.zhu&quot;</code></p>
</li>
<li><p>启动时：使用隐式跳转</p>
</li>
</ol>
<blockquote>
<p>这种添加权限的方法必须要AppB先安装，否则AppA无法获取权限</p>
</blockquote>
<h4 id="拒绝服务漏洞"><a href="#拒绝服务漏洞" class="headerlink" title="拒绝服务漏洞"></a>拒绝服务漏洞</h4><p>在被启动的Activity中，<code>getIntent().getExtras()</code>获取的bundle对象中如果有的序列化数据，无法被反序列化成对象，程序就会崩溃（报找不到反序列化对象的exception），此时需要对bundle的操作加try-catch。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/22/Activity的启动流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/22/Activity的启动流程/" itemprop="url">Activity的启动流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-22T22:29:45+08:00">
                2019-08-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Activity跨进程启动"><a href="#Activity跨进程启动" class="headerlink" title="Activity跨进程启动"></a>Activity跨进程启动</h4><ol>
<li>请求进程A通过startActivity方法调用AMP</li>
<li>system_server进程中的AMS执行：<ol>
<li>解析Activity信息（androidManifest.xml）</li>
<li>处理启动参数</li>
<li>启动目标进程</li>
<li>绑定新进程</li>
<li>调用ATP（ApplicationThread代理）</li>
</ol>
</li>
<li>目标进程B通过ApplicationThread调用ActivityThread，最终启动Activity的生命周期</li>
</ol>
<blockquote>
<p>AMP -&gt; AMS 以及 ATP -&gt; ApplicationThread都是通过binder进行通信的</p>
</blockquote>
<h4 id="Activity进程内启动"><a href="#Activity进程内启动" class="headerlink" title="Activity进程内启动"></a>Activity进程内启动</h4><ol>
<li>请求进程A通过startActivity方法调用AMP</li>
<li>system_server进程中的AMS执行：<ol>
<li>解析Activity信息（androidManifest.xml）</li>
<li>处理启动参数</li>
<li>调用ATP（ApplicationThread代理）</li>
</ol>
</li>
<li>进程A过ApplicationThread调用ActivityThread，最终启动Activity的生命周期</li>
</ol>
<h4 id="Activity的参数传递"><a href="#Activity的参数传递" class="headerlink" title="Activity的参数传递"></a>Activity的参数传递</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">请求进程A的Bundle -- Binder缓冲区  --&gt; system_server进程的Bundle</span><br></pre></td></tr></table></figure>
<ul>
<li>大小受缓冲区大小限制</li>
<li>数据必须可以序列化</li>
</ul>
<p>解决办法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">ActivityA的Bundle -- Binder缓冲区-key --&gt; ActivityB的Bundle</span><br><span class="line">ActivityA的Bundle -- setData --&gt; Model-data</span><br><span class="line">Model-data -- getData --&gt; ActivityB的Bundle</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Activity之间的数据传递不能太大</p>
</blockquote>
<h4 id="Activity实例化"><a href="#Activity实例化" class="headerlink" title="Activity实例化"></a>Activity实例化</h4><p>通过反射newInstance实现，所以不能对Activity添加构造方法。</p>
<p>同理，fragment也一样。</p>
<h4 id="Activity的窗口如何展示"><a href="#Activity的窗口如何展示" class="headerlink" title="Activity的窗口如何展示"></a>Activity的窗口如何展示</h4><h4 id="Activity转场动画的实现机制"><a href="#Activity转场动画的实现机制" class="headerlink" title="Activity转场动画的实现机制"></a>Activity转场动画的实现机制</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhujiaqqq</p>
              <p class="site-description motion-element" itemprop="description">Java Android Python Algorithm and Machine learning</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">46</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhujiaqqq</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>

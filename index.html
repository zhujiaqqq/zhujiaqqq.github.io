<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="Java Android Python Algorithm and Machine learning">
<meta property="og:type" content="website">
<meta property="og:title" content="Zhujiaqqq Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Zhujiaqqq Blog">
<meta property="og:description" content="Java Android Python Algorithm and Machine learning">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zhujiaqqq Blog">
<meta name="twitter:description" content="Java Android Python Algorithm and Machine learning">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Zhujiaqqq Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zhujiaqqq Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/15/Java的GC机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/15/Java的GC机制/" itemprop="url">Java的GC机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-15T15:04:59+08:00">
                2019-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="判断哪些对象需要被GC"><a href="#判断哪些对象需要被GC" class="headerlink" title="判断哪些对象需要被GC"></a>判断哪些对象需要被GC</h3><ul>
<li>堆</li>
<li>方法区</li>
<li>JVM栈</li>
<li><p>本地方法栈</p>
<p>可达性分析方法（Java使用）：通过判断对象是否被GC Root 直接或间接引用，进而判断对象是否可用，如果对象不可以就可以对这个对象进行GC</p>
</li>
</ul>
<p>引用计数方法（python使用）：每个对象有一个引用计数属性，新增一个引用时计数加1，引用释放时计数减1，计数为0时可以回收。此方法简单，但无法解决对象相互循环引用的问题。</p>
<h3 id="如何触发GC"><a href="#如何触发GC" class="headerlink" title="如何触发GC"></a>如何触发GC</h3><ul>
<li>程序调用System.gc()</li>
<li>根据Eden区和FromSpace区的内存大小来决定，如果内存不足，则会启动GC（此时应用线程停止）</li>
</ul>
<p><strong>GC又分为 minor GC 和 Full GC (也称为 Major GC )</strong></p>
<p>Minor GC触发条件：当Eden区满时，触发Minor GC。</p>
<p>Full GC触发条件：</p>
<p>  a.调用System.gc时，系统建议执行Full GC，但是不必然执行</p>
<p>  b.老年代空间不足</p>
<p>  c.方法去空间不足</p>
<p>  d.通过Minor GC后进入老年代的平均大小大于老年代的可用内存</p>
<p>  e.由Eden区、From Space区向To Space区复制时，对象大小大于To Space可用内存，则把该对象转存到老年代，且老年代的可用内存小于该对象大小</p>
<h3 id="GC算法"><a href="#GC算法" class="headerlink" title="GC算法"></a>GC算法</h3><p>GC常用算法有：<strong>标记-清除算法</strong>，<strong>标记-压缩算法</strong>，<strong>复制算法</strong>，<strong>分代收集算法。</strong></p>
<h3 id="新生代、老年代的转化过程"><a href="#新生代、老年代的转化过程" class="headerlink" title="新生代、老年代的转化过程"></a>新生代、老年代的转化过程</h3><p>具体过程：新生代(Young)分为Eden区，From区与To区</p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191015153753.png" alt></p>
<p>当系统创建一个对象的时候，总是在Eden区操作，当这个区满了，那么就会触发一次YoungGC，也就是年轻代的垃圾回收。一般来说这时候不是所有的对象都没用了，所以就会把还能用的对象复制到From区。 </p>
<p> <img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191015153716.png" alt></p>
<p>这样整个Eden区就被清理干净了，可以继续创建新的对象，当Eden区再次被用完，就再触发一次YoungGC，然后呢，注意，这个时候跟刚才稍稍有点区别。这次触发YoungGC后，会将Eden区与From区还在被使用的对象复制到To区， </p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191015153717.png" alt></p>
<p>再下一次YoungGC的时候，则是将Eden区与To区中的还在被使用的对象复制到From区。</p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191015153718.png" alt></p>
<p>经过若干次YoungGC后，有些对象在From与To之间来回游荡，这时候From区与To区亮出了底线（阈值），这些家伙要是到现在还没挂掉，对不起，一起滚到（复制）老年代吧。 </p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191015153719.png" alt></p>
<p>老年代经过这么几次折腾，也就扛不住了（空间被用完），好，那就来次集体大扫除（Full GC），也就是全量回收。如果Full GC使用太频繁的话，无疑会对系统性能产生很大的影响。所以要合理设置年轻代与老年代的大小，尽量减少Full GC的操作。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/06/使用APT实现Android组件化路由功能/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/06/使用APT实现Android组件化路由功能/" itemprop="url">使用APT实现Android组件化路由功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-06T16:30:42+08:00">
                2019-10-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="组件化后不同模块之间Activity的跳转"><a href="#组件化后不同模块之间Activity的跳转" class="headerlink" title="组件化后不同模块之间Activity的跳转"></a>组件化后不同模块之间Activity的跳转</h2><p>组件化后，只有主工程模块依赖其他业务模块，而各个业务模块之间没有互相依赖关系。一个模块可以调用被依赖模块的类和方法，而被依赖的模块不能引用依赖模块的类（依赖只能单向传递）。所以，单个业务模块无法调用主模块和其他业务模块的类和方法，那么业务间Activity的跳转就需要使用隐式跳转：</p>
<ul>
<li>直接跳转包名：<code>startActivity(new Intent(“com.example.boost”))</code></li>
<li>使用manifest中的action、category、data进行隐式跳转：<code>startActivity(new Intent(Intent.ACTION_VIEW, Uri.prase(&quot;xxxx&quot;)))</code></li>
<li>利用反射</li>
</ul>
<p>以上这些方法，虽然都能实现不同模块间的Activity跳转。但是，隐式跳转容易被非法应用劫持，反射最大的弊端在于代码结构发生变化后，就需要修改相应的反射路径。</p>
<p><strong>目前比较推荐的方法就是使用一套统一的路由框架，所有的业务模块、主模块都依赖于这个路由模块，路由模块中包含所有Activity的引用，这样，每个模块都可以互相调用不同的模块的Activity。</strong></p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191006181317.png" alt="路由框架"></p>
<hr>
<h2 id="搭建路由模块"><a href="#搭建路由模块" class="headerlink" title="搭建路由模块"></a>搭建路由模块</h2><p>路由模块需要包含所有Activity类的引用，并能进行跳转，所有需要建立一个Android Library。</p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191006191058.png" alt="20191006191058"></p>
<p>Route路由类的设计：</p>
<ul>
<li>Route类作为路由需要在每个模块中可以直接调用，那最方便的方法就是使用单例模式</li>
<li>Route中要包含所有Activity的引用，那么就需要使用一个map将Activity和对应的名称关联起来</li>
<li>在使用路由进行页面跳转的时候需要有一个方法，方法要传入待跳转的Activity的名称和需要的参数</li>
<li>Route需要一个方法，将Activity的引用和对应的名称传入路由中</li>
</ul>
<p>具体的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.route;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.app.Application;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dalvik.system.DexFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: jiazhu</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019-09-19 09:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Route</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Route</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Route route = <span class="keyword">new</span> Route();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Class&lt;? extends Activity&gt;&gt; activityList;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Route</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        activityList = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Route <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> route;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">        mContext = application;</span><br><span class="line">        List&lt;String&gt; classNames = getClassName(<span class="string">"com.example.util"</span>);</span><br><span class="line">        <span class="keyword">for</span> (String s : classNames) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; aClass = Class.forName(s);</span><br><span class="line">                <span class="keyword">if</span> (IRoute.class.isAssignableFrom(aClass)) &#123;</span><br><span class="line">                    IRoute iRoute = (IRoute) aClass.newInstance();</span><br><span class="line">                    iRoute.putActivity();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getClassName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; classList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        String path = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            path = mContext.getPackageManager().getApplicationInfo(mContext.getPackageName(), <span class="number">0</span>).sourceDir;</span><br><span class="line">            DexFile dexFile = <span class="keyword">new</span> DexFile(path);</span><br><span class="line">            Enumeration&lt;String&gt; entries = dexFile.entries();</span><br><span class="line">            <span class="keyword">while</span> (entries.hasMoreElements()) &#123;</span><br><span class="line">                String name = entries.nextElement();</span><br><span class="line">                <span class="keyword">if</span> (name.contains(packageName)) &#123;</span><br><span class="line">                    classList.add(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> classList;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putActivity</span><span class="params">(String path, Class&lt;? extends Activity&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(path)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        activityList.put(path, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jumpActivity</span><span class="params">(String path, Bundle bundle)</span> </span>&#123;</span><br><span class="line">        Class&lt;? extends Activity&gt; aClass = activityList.get(path);</span><br><span class="line">        <span class="keyword">if</span> (aClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent().setClass(mContext, aClass);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        <span class="keyword">if</span> (bundle != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.putExtra(<span class="string">"bundle"</span>, bundle);</span><br><span class="line">        &#125;</span><br><span class="line">        mContext.startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于init方法，在整个应用启动的时候需要被调用，这样可以获取Application作为以后跳转的context上下文；除此之外，还需要将每一个模块中的Activity获取到，传入Route中。</p>
<p>Route中有一个putActivity()的方法，这个方法可以将Activity的引用和名称传入Route中，那么在每一个模块中如何才能调用这个方法，将本模块的Activity传递给Route呢？</p>
<hr>
<h2 id="使用APT（注解处理工具）将每一个模块的Activity传入Route路由"><a href="#使用APT（注解处理工具）将每一个模块的Activity传入Route路由" class="headerlink" title="使用APT（注解处理工具）将每一个模块的Activity传入Route路由"></a>使用APT（注解处理工具）将每一个模块的Activity传入Route路由</h2><blockquote>
<p> APT全名：Annotation Processiong Tool。</p>
</blockquote>
<p>使用APT需要有两个部分组成，一个是注解，另一个是处理注解。</p>
<h4 id="1-注解"><a href="#1-注解" class="headerlink" title="1. 注解"></a>1. 注解</h4><p>这里不需要Android相关的内容，所有新建一个Java Library：</p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191006193602.png" alt="20191006193602"></p>
<p>这个模块中只需要创建注解类。</p>
<p>一个注解类主要有以下几个部分构成：</p>
<ul>
<li><code>@Target()</code>指定这个注解是针对哪类数据进行注解：TYPE：类；FIELD：元素；METHOD：方法；PARAMETER：参数…</li>
<li><code>@Retention()</code>指定这个注解的生效阶段：SOURCE：在源码阶段有效；CLASS：在编译期有效；RUNTIME：在运行时有效</li>
<li><code>@interface xxx{}</code>注解类名称</li>
<li>注解的方法</li>
</ul>
<p>针对路由框架，实现的注解如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jiazhu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindPath &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出：</p>
<ol>
<li>这个注解类是针对类进行注解的</li>
<li>注解在编译期有效</li>
<li>注解BindPath中有一个方法：value()，这个方法获取一个String类型值</li>
</ol>
<p>BindPath获取的值作为Activity的名称，Activity的引用可以在后面通过注解处理器进行获取。</p>
<h4 id="2-处理注解"><a href="#2-处理注解" class="headerlink" title="2.处理注解"></a>2.处理注解</h4><p>处理注解也是不需要Android相关的内容，所有新建一个Java Library。</p>
<p>做一个注解处理器的类，需要集成<code>AbstractProcessor</code>注解处理器抽象类。</p>
<p>在处理注解之前，需要实现三个方法：</p>
<ul>
<li><p>初始化这个注解处理器，并拿到一个创建文件的对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line">    mFiler = processingEnvironment.getFiler();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置需要处理的注解类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; types = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    types.add(BindPath.class.getCanonicalName());</span><br><span class="line">    <span class="keyword">return</span> types;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置支持的代码版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> processingEnv.getSourceVersion();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>然后需要重写父类的process方法，实现注解的处理。处理的步骤如下：</p>
<ol>
<li>获取需要处理的被注解标注的对象，并获取对象的注解</li>
<li>将对象的名称和注解方法返回的值提取出来（对象名称就是Activity，注解方法的返回值就是Activity的名称）</li>
<li>通过Filer创建每个模块对应的添加路由的类，并用Writer写入刚才通过注解获取的Activity和名称。</li>
</ol>
<p>最终代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jiazhu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AutoService</span>(Processor.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationCompiler</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line">    Filer mFiler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line">    mFiler = processingEnvironment.getFiler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; types = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    types.add(BindPath.class.getCanonicalName());</span><br><span class="line">    <span class="keyword">return</span> types;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> processingEnv.getSourceVersion();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</span><br><span class="line">        Set&lt;? extends Element&gt; elements = roundEnvironment.getElementsAnnotatedWith(BindPath.class);</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        String packageName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) &#123;</span><br><span class="line">            <span class="keyword">if</span> (element <span class="keyword">instanceof</span> TypeElement) &#123;</span><br><span class="line">                TypeElement typeElement = (TypeElement) element;</span><br><span class="line">                BindPath annotation = typeElement.getAnnotation(BindPath.class);</span><br><span class="line">                String path = annotation.value();</span><br><span class="line">                String activityName = typeElement.getQualifiedName().toString();</span><br><span class="line">                <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    packageName = activityName.substring(<span class="number">0</span>, activityName.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">                    packageName = packageName.replace(<span class="string">'.'</span>, <span class="string">'_'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                map.put(path, activityName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            Writer writer = <span class="keyword">null</span>;</span><br><span class="line">            String utilName = <span class="string">"ActivityUtil_"</span> + packageName;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                JavaFileObject javaFileObject = mFiler.createSourceFile(<span class="string">"com.example.util."</span> + utilName);</span><br><span class="line">                writer = javaFileObject.openWriter();</span><br><span class="line">                Iterator&lt;String&gt; iterator = map.keySet().iterator();</span><br><span class="line">                writer.write(<span class="string">"package com.example.util;\n"</span> +</span><br><span class="line">                        <span class="string">"\n"</span> +</span><br><span class="line">                        <span class="string">"import com.example.route.IRoute;\n"</span> +</span><br><span class="line">                        <span class="string">"import com.example.route.Route;\n"</span> +</span><br><span class="line">                        <span class="string">"\n"</span> +</span><br><span class="line">                        <span class="string">"public class "</span> + utilName + <span class="string">" implements IRoute &#123;\n"</span> +</span><br><span class="line">                        <span class="string">"    @Override\n"</span> +</span><br><span class="line">                        <span class="string">"    public void putActivity() &#123;\n"</span>);</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    String path = iterator.next();</span><br><span class="line">                    String value = map.get(path);</span><br><span class="line">                    writer.write(<span class="string">"Route.getInstance().putActivity(\""</span> + path + <span class="string">"\","</span> + value + <span class="string">".class);\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                writer.write(<span class="string">"    &#125;\n"</span> +</span><br><span class="line">                        <span class="string">"&#125;\n"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (writer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        writer.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过注解，将各个模块的Activity添加注解，然后对代码进行一次编译。</p>
<p>在每一个模块生成的代码中会多出来一个类，这个类会将这个模块中的所有已注解的Activity和它们的名称传入Route类中。</p>
<p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20191006211440.png" alt></p>
<p>当我们跳转某个模块的Activity的时候，只需要如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Route.getInstance().jumpActivity( <span class="string">"mapp/main"</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/02/JNI层动态注册Native方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/02/JNI层动态注册Native方法/" itemprop="url">JNI层动态注册Native方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-02T21:52:45+08:00">
                2019-10-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android中，通常创建native的方法是在java层写一个native的方法声明，然后通过Alt+enter进行自动生成jni的方法，或者在命令行中使用javah生成头问题然后对照头问题的函数名，在c文件中创建函数。这种属于静态注册方法，虽然在AS中使用非常方法，但是有一下几个弊端：</p>
<ol>
<li>在调用该方法时，有额外的查找方法的性能开销</li>
<li>在后期需要重构代码时，jni中的函数名需要手动修改，比较麻烦</li>
<li>在程序运行时，无法动态更换</li>
</ol>
<p>所以，在NDK开发时，可以使用动态注册Native方法来规避上面的问题。</p>
<p>动态注册方法是通过jni中的JNI_OnLoad方法实现的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>JNI_OnLoad()</code>方法在虚拟机加载C库是被执行（当<code>System.loadLibrary(&quot;native-lib&quot;)</code>时）。</p>
<p>在<code>JNI_OnLoad()</code>中使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">RegisterNatives</span><span class="params">(jclass clazz, <span class="keyword">const</span> JNINativeMethod* methods,</span></span></span><br><span class="line"><span class="function"><span class="params">      jint nMethods)</span></span></span><br></pre></td></tr></table></figure>
<p>对native方法进行注册。<code>RegisterNatives()</code>中需要三个参数：</p>
<ul>
<li><p>clazz指的是native方法所在的类，可以使用env-&gt;FindClass()获取；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jclass clazz = env-&gt;FindClass(<span class="string">"com/example/jni/MainActivity"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>methods指的是需要动态注册的方法（这是一个指向数组的指针）,<code>JNINativeMethod</code>是一个结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature;</span><br><span class="line">    <span class="keyword">void</span>*       fnPtr;</span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure>
<ul>
<li>name是java层的方法名；</li>
<li>signature是方法的出参入参的类型</li>
<li>fnPtr是jni层的函数指针</li>
</ul>
</li>
<li><p>nMethods指的是需要动态注册的方法的个数，就是methods的长度：<code>sizeof(g_methods) / sizeof(g_methods[0])</code></p>
</li>
</ul>
<hr>
<p>最终的实现：</p>
<p>Java层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">_test</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>jni层：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">my_jni_test(JNIEnv *env, jobject instance) &#123;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"this is a method"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> JNINativeMethod g_methods[] = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">"_test"</span>,</span><br><span class="line">                <span class="string">"()Ljava/lang/String;"</span>,</span><br><span class="line">                (<span class="keyword">void</span> *) my_jni_test</span><br><span class="line">        &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span> </span>&#123;</span><br><span class="line">    JNIEnv *env = <span class="literal">nullptr</span>;</span><br><span class="line">    vm-&gt;GetEnv((<span class="keyword">void</span> **) &amp;env, JNI_VERSION_1_6);</span><br><span class="line"></span><br><span class="line">    jclass clazz = env-&gt;FindClass(<span class="string">"com/example/jni/MainActivity"</span>);</span><br><span class="line"></span><br><span class="line">    env-&gt;RegisterNatives(clazz, g_methods, <span class="keyword">sizeof</span>(g_methods) / <span class="keyword">sizeof</span>(g_methods[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/22/FFmpeg抽取视频数据/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/22/FFmpeg抽取视频数据/" itemprop="url">FFmpeg抽取视频数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-22T20:44:11+08:00">
                2019-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/音视频/" itemprop="url" rel="index">
                    <span itemprop="name">音视频</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>SPS/PPS在ffmpeg的codec-&gt;extradata中获取</p>
<ol>
<li><p>加载ffmpeg的日志模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span><br><span class="line">...</span><br><span class="line">av_log_set_level(AV_LOG_DEBUG);</span><br></pre></td></tr></table></figure>
</li>
<li><p>注册所有编解码器</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*register all formats and codec*/</span></span><br><span class="line">av_register_all();</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开视频文件并获取视频文件上下文</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AVFormatContext *fmt_ctx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*open input media file, and allocate format context*/</span></span><br><span class="line"><span class="keyword">if</span>((err_code = avformat_open_input(&amp;fmt_ctx, src_filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">	av_strerror(err_code, errors, <span class="number">1024</span>);</span><br><span class="line">	av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"Could not open source file: %s, %d(%s)\n"</span>,</span><br><span class="line">               src_filename,</span><br><span class="line">               err_code,</span><br><span class="line">               errors);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印视频详细信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*dump input information*/</span></span><br><span class="line">av_dump_format(fmt_ctx, <span class="number">0</span>, src_filename, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成一个空的数据包，用于接收视频包</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*initialize packet*/</span></span><br><span class="line">av_init_packet(&amp;pkt);</span><br><span class="line">pkt.data = <span class="literal">NULL</span>;</span><br><span class="line">pkt.size = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取视频流</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*find best video stream*/</span></span><br><span class="line">video_stream_index = av_find_best_stream(fmt_ctx, AVMEDIA_TYPE_VIDEO, <span class="number">-1</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (video_stream_index &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Could not find %s stream in input file %s\n"</span>,  av_get_media_type_string(AVMEDIA_TYPE_VIDEO),src_filename);</span><br><span class="line">	<span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环读取视频流中的包，进行处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*read frames from media file*/</span></span><br><span class="line"><span class="keyword">while</span> (av_read_frame(fmt_ctx, &amp;pkt) &gt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (pkt.stream_index == video_stream_index)</span><br><span class="line">&#123;</span><br><span class="line">   h264_mp4toannexb(fmt_ctx, &amp;pkt, dst_fd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//release pkt-&gt;data</span></span><br><span class="line">av_packet_unref(&amp;pkt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>对包进行处理，提取帧数据进行写文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h264_mp4toannexb</span><span class="params">(AVFormatContext *fmt_ctx, AVPacket *in, FILE *dst_fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    AVPacket *out = <span class="literal">NULL</span>;</span><br><span class="line">    AVPacket spspps_pkt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">uint8_t</span> unit_type;</span><br><span class="line">    <span class="keyword">int32_t</span> nal_size;</span><br><span class="line">    <span class="keyword">uint32_t</span> cumul_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *buf_end;</span><br><span class="line">    <span class="keyword">int</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, i;</span><br><span class="line"></span><br><span class="line">    out = av_packet_alloc();</span><br><span class="line"></span><br><span class="line">    buf = in-&gt;data;</span><br><span class="line">    buf_size = in-&gt;size;</span><br><span class="line">    buf_end = in-&gt;data + in-&gt;size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        ret = AVERROR(EINVAL);</span><br><span class="line">        <span class="keyword">if</span> (buf + <span class="number">4</span> <span class="comment">/*s-&gt;length_size*/</span> &gt; buf_end)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        <span class="comment">//一个AVPacket中存的可能是一帧也可能是多帧</span></span><br><span class="line">        <span class="comment">// nal_size是一个帧的具体大小，在帧的头部的前4个字节</span></span><br><span class="line">        <span class="keyword">for</span> (nal_size = <span class="number">0</span>, i = <span class="number">0</span>; i &lt; <span class="number">4</span> <span class="comment">/*s-&gt;length_size*/</span>; i++)</span><br><span class="line">            nal_size = (nal_size &lt;&lt; <span class="number">8</span>) | buf[i];</span><br><span class="line"></span><br><span class="line">        buf += <span class="number">4</span>; <span class="comment">/*s-&gt;length_size;*/</span></span><br><span class="line">        <span class="comment">//帧数据的第一个字节的后5位是这个帧的nal单元</span></span><br><span class="line">        <span class="comment">/* nal:     7 -&gt; sps</span></span><br><span class="line"><span class="comment">                    8 -&gt; pps</span></span><br><span class="line"><span class="comment">                    key frame -&gt; 5</span></span><br><span class="line"><span class="comment">                    normal frame -&gt; 1 */</span></span><br><span class="line">        unit_type = *buf &amp; <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nal_size &gt; buf_end - buf || nal_size &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        <span class="comment">/* prepend only to the first type 5 NAL unit of an IDR picture, if no sps/pps are already present */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="comment">/*s-&gt;new_idr &amp;&amp; */</span> unit_type == <span class="number">5</span> <span class="comment">/*&amp;&amp; !s-&gt;idr_sps_seen &amp;&amp; !s-&gt;idr_pps_seen*/</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 关键帧，需要获取sps/pps数据，并重新修改视频宽高比等参数</span></span><br><span class="line">            h264_extradata_to_annexb(fmt_ctx-&gt;streams[in-&gt;stream_index]-&gt;codec-&gt;extradata,</span><br><span class="line">                                     fmt_ctx-&gt;streams[in-&gt;stream_index]-&gt;codec-&gt;extradata_size,</span><br><span class="line">                                     &amp;spspps_pkt,</span><br><span class="line">                                     AV_INPUT_BUFFER_PADDING_SIZE);</span><br><span class="line">            <span class="comment">// 为数据增加特征码</span></span><br><span class="line">            <span class="keyword">if</span> ((ret = alloc_and_copy(out,</span><br><span class="line">                                      spspps_pkt.data, spspps_pkt.size,</span><br><span class="line">                                      buf, nal_size)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">            <span class="comment">/*s-&gt;new_idr = 0;*/</span></span><br><span class="line">            <span class="comment">/* if only SPS has been seen, also insert PPS */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ret = alloc_and_copy(out, <span class="literal">NULL</span>, <span class="number">0</span>, buf, nal_size)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        len = fwrite(out-&gt;data, <span class="number">1</span>, out-&gt;size, dst_fd);</span><br><span class="line">        <span class="keyword">if</span> (len != out-&gt;size)</span><br><span class="line">        &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_DEBUG, <span class="string">"warning, length of writed data isn't equal pkt.size(%d, %d)\n"</span>,</span><br><span class="line">                   len,</span><br><span class="line">                   out-&gt;size);</span><br><span class="line">        &#125;</span><br><span class="line">        fflush(dst_fd);</span><br><span class="line"></span><br><span class="line">    next_nal:</span><br><span class="line">        buf += nal_size;</span><br><span class="line">        cumul_size += nal_size + <span class="number">4</span>; <span class="comment">//s-&gt;length_size;</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (cumul_size &lt; buf_size);</span><br><span class="line">fail:</span><br><span class="line">    av_packet_free(&amp;out);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<ol start="2">
<li><p>获取SPS/PPS数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h264_extradata_to_annexb</span><span class="params">(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *codec_extradata, <span class="keyword">const</span> <span class="keyword">int</span> codec_extradata_size, AVPacket *out_extradata, <span class="keyword">int</span> padding)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint16_t</span> unit_size;</span><br><span class="line">    <span class="keyword">uint64_t</span> total_size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> *out = <span class="literal">NULL</span>, unit_nb, sps_done = <span class="number">0</span>,</span><br><span class="line">            sps_seen = <span class="number">0</span>, pps_seen = <span class="number">0</span>, sps_offset = <span class="number">0</span>, pps_offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> *extradata = codec_extradata + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint8_t</span> nalu_header[<span class="number">4</span>] = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> length_size = (*extradata++ &amp; <span class="number">0x3</span>) + <span class="number">1</span>; <span class="comment">// retrieve length coded size, 用于指示表示编码数据长度所需字节数</span></span><br><span class="line"></span><br><span class="line">    sps_offset = pps_offset = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* retrieve sps and pps unit(s) */</span></span><br><span class="line">    unit_nb = *extradata++ &amp; <span class="number">0x1f</span>; <span class="comment">/* number of sps unit(s) */</span></span><br><span class="line">    <span class="keyword">if</span> (!unit_nb)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">goto</span> pps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sps_offset = <span class="number">0</span>;</span><br><span class="line">        sps_seen = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (unit_nb--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">        unit_size = AV_RB16(extradata);</span><br><span class="line">        total_size += unit_size + <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> (total_size &gt; INT_MAX - padding)</span><br><span class="line">        &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR,</span><br><span class="line">                   <span class="string">"Too big extradata size, corrupted stream or invalid MP4/AVCC bitstream\n"</span>);</span><br><span class="line">            av_free(out);</span><br><span class="line">            <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (extradata + <span class="number">2</span> + unit_size &gt; codec_extradata + codec_extradata_size)</span><br><span class="line">        &#123;</span><br><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Packet header is not contained in global extradata, "</span></span><br><span class="line">                                       <span class="string">"corrupted stream or invalid MP4/AVCC bitstream\n"</span>);</span><br><span class="line">            av_free(out);</span><br><span class="line">            <span class="keyword">return</span> AVERROR(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((err = av_reallocp(&amp;out, total_size + padding)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        <span class="built_in">memcpy</span>(out + total_size - unit_size - <span class="number">4</span>, nalu_header, <span class="number">4</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(out + total_size - unit_size, extradata + <span class="number">2</span>, unit_size);</span><br><span class="line">        extradata += <span class="number">2</span> + unit_size;</span><br><span class="line">    pps:</span><br><span class="line">        <span class="keyword">if</span> (!unit_nb &amp;&amp; !sps_done++)</span><br><span class="line">        &#123;</span><br><span class="line">            unit_nb = *extradata++; <span class="comment">/* number of pps unit(s) */</span></span><br><span class="line">            <span class="keyword">if</span> (unit_nb)</span><br><span class="line">            &#123;</span><br><span class="line">                pps_offset = total_size;</span><br><span class="line">                pps_seen = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (out)</span><br><span class="line">        <span class="built_in">memset</span>(out + total_size, <span class="number">0</span>, padding);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sps_seen)</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING,</span><br><span class="line">               <span class="string">"Warning: SPS NALU missing or invalid. "</span></span><br><span class="line">               <span class="string">"The resulting stream may not play.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pps_seen)</span><br><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_WARNING,</span><br><span class="line">               <span class="string">"Warning: PPS NALU missing or invalid. "</span></span><br><span class="line">               <span class="string">"The resulting stream may not play.\n"</span>);</span><br><span class="line"></span><br><span class="line">    out_extradata-&gt;data = out;</span><br><span class="line">    out_extradata-&gt;size = total_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> length_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="3">
<li><p>为每一帧数据增加特征码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_and_copy</span><span class="params">(AVPacket *out,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">uint8_t</span> *sps_pps, <span class="keyword">uint32_t</span> sps_pps_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">uint8_t</span> *in, <span class="keyword">uint32_t</span> in_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> offset = out-&gt;size;</span><br><span class="line">    <span class="keyword">uint8_t</span> nal_header_size = offset ? <span class="number">3</span> : <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    err = av_grow_packet(out, sps_pps_size + in_size + nal_header_size);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sps_pps)</span><br><span class="line">        <span class="built_in">memcpy</span>(out-&gt;data + offset, sps_pps, sps_pps_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(out-&gt;data + sps_pps_size + nal_header_size + offset, in, in_size);</span><br><span class="line">    <span class="keyword">if</span> (!offset)</span><br><span class="line">    &#123;</span><br><span class="line">        AV_WB32(out-&gt;data + sps_pps_size, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        (out-&gt;data + offset + sps_pps_size)[<span class="number">0</span>] =</span><br><span class="line">            (out-&gt;data + offset + sps_pps_size)[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        (out-&gt;data + offset + sps_pps_size)[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/05/如何对图片进行缓存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/05/如何对图片进行缓存/" itemprop="url">如何对图片进行缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-05T21:17:54+08:00">
                2019-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="设计缓存算法的时候需要考虑"><a href="#设计缓存算法的时候需要考虑" class="headerlink" title="设计缓存算法的时候需要考虑"></a>设计缓存算法的时候需要考虑</h3><ul>
<li>哪些应该保存</li>
<li>哪些应该丢弃</li>
<li>什么时候丢弃</li>
<li>获取数据的成本和缓存数据的成本</li>
<li>缓存价值（命中率）</li>
</ul>
<h4 id="LRU（Least-Recently-Used）算法的实现"><a href="#LRU（Least-Recently-Used）算法的实现" class="headerlink" title="LRU（Least Recently Used）算法的实现"></a>LRU（Least Recently Used）算法的实现</h4><ul>
<li>LRU内部包含一个LinkedHashMap</li>
<li>统计监控（额外的开销，可以监控算法的有效性）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> putCount;<span class="comment">//放入个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> createCount;<span class="comment">//创建个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> evictionCount;<span class="comment">//弹出个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> hitCount;<span class="comment">//命中个数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> missCount;<span class="comment">//没命中个数</span></span><br></pre></td></tr></table></figure>
<h4 id="LFU（Least-Frequently-Used）"><a href="#LFU（Least-Frequently-Used）" class="headerlink" title="LFU（Least Frequently Used）"></a>LFU（Least Frequently Used）</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/03/如何避免OOM产生/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/03/如何避免OOM产生/" itemprop="url">如何避免OOM产生</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-03T22:36:42+08:00">
                2019-09-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="OOM的产生"><a href="#OOM的产生" class="headerlink" title="OOM的产生"></a>OOM的产生</h3><ul>
<li>已使用内存+新申请内存&gt;可分配内存</li>
<li>OOM几乎覆盖所有的内存区域，通常指堆内存</li>
<li>Native Heap在物理内存不够时也会抛出OOM</li>
</ul>
<h3 id="使用合适的数据结构"><a href="#使用合适的数据结构" class="headerlink" title="使用合适的数据结构"></a>使用合适的数据结构</h3><ul>
<li>HashMap——大于1000个数、增删频繁</li>
<li>ArrayMap——key不是整型</li>
<li>SparseArray——Key是整型（池化技术、内存复用）</li>
</ul>
<h3 id="避免使用枚举"><a href="#避免使用枚举" class="headerlink" title="避免使用枚举"></a>避免使用枚举</h3><p>每一个枚举就是一个对象，对象至少占24字节。所以使用静态常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(value = RetentionPolicy.SOURCE)</span><br><span class="line"><span class="meta">@IntDef</span>(value = &#123;COMMON, LOAD_MORE, LOAD_REFRESH&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> LoadType &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMMON = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_MORE = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOAD_REFRESH = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>Kotlin 可以使用内联类，编译时转化为int，节省内存。</p>
<h3 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h3><ul>
<li><p>尽量根据实际需求选择合适的分辨率</p>
</li>
<li><p>不用帧动画，使用代码实现动效</p>
</li>
<li><p>使用Bitmap重采用和复用配置</p>
<h3 id="使用NDK"><a href="#使用NDK" class="headerlink" title="使用NDK"></a>使用NDK</h3></li>
<li><p>Native Heap没有专门的使用限制</p>
</li>
<li>内存大户的核心逻辑主要在Native 层</li>
</ul>
<h3 id="内存优化5R法则"><a href="#内存优化5R法则" class="headerlink" title="内存优化5R法则"></a>内存优化5R法则</h3><ul>
<li>Reduce缩减：降低图片分辨率/重采样/抽稀策略</li>
<li>Reuse复用：池化策略/避免频繁创建对象，减小GC压力</li>
<li>Recycle回收：主动销毁、结束，避免内存泄露/生命周期闭环</li>
<li>Refactor重构：更合适的数据结构/更合理的程序架构</li>
<li>Revalue重审：谨慎使用Large Heap/多进程/第三方框架</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/01/RxJava中CompositeDisposable注意事项/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/01/RxJava中CompositeDisposable注意事项/" itemprop="url">RxJava中CompositeDisposable注意事项</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-01T16:14:39+08:00">
                2019-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在RxJava中，Observable被订阅后，可以得到一个Disposable对象。为了防止内存泄露，一般情况下，都会在Activity结束的时候调用Disposable对象的dispose()方法，解除订阅。</p>
<p>RxJava2中，提供了一个CompositeDisposable类作为Disposable的容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeDisposable</span> <span class="keyword">implements</span> <span class="title">Disposable</span>, <span class="title">DisposableContainer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    OpenHashSet&lt;Disposable&gt; resources;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> disposed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates an empty CompositeDisposable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CompositeDisposable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">  	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，CompositeDisposable实现了Disposable接口（void dispose();方法）；实现了DisposableContainer接口，可以add、remove、delete操作Disposable。</p>
<p>重点要关注两个方法：</p>
<p>1、<code>add(@NonNull Disposable d)</code>这个方法是将一个dispoable加入CompositeDisposable中，当Activity或者Fragment的生命周期结束的时候，通过</p>
<p>dispose()方法将Observable的订阅事件取消关联，防止内存泄露。</p>
<p>2、<code>public void dispose()</code>这个方法就是CompositeDisposable中将所有的Observable的订阅事件取消关联使用。</p>
<hr>
<p>之前遇到过一个问题：</p>
<blockquote>
<p>使用MVP模式开发的时候，Activity A的Presenter中包含CompositeDisposable对象，Activity A的onStart（）方法中关联了A的Presenter，当Activity A 跳转到Activity B的时候，我在A的onStop（）方法中调用了CompositeDisposable.dispose()方法。当Activity B 调用finish（）方法结束时候，回到Activity A页面，Activity A上的所有关于RxJava的调用都失效。</p>
</blockquote>
<p>我通过Debug的方式一层层的查看方法的调用栈对比正常的情况，最终发现：</p>
<p>CompositeDisposable的dispose()方法在被调用之后，所有的add()进来的Disposable都会直接调用自身的dispose()方法，也就是说在事件刚被绑定监听的时候就被解除绑定了。</p>
<p>查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    OpenHashSet&lt;Disposable&gt; set;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (disposed) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        disposed = <span class="keyword">true</span>;</span><br><span class="line">        set = resources;</span><br><span class="line">        resources = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dispose(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在dispose() 方法调用的时候，会将全局变量<code>disposed</code>置为true。</p>
<p>再看add方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(@NonNull Disposable d)</span> </span>&#123;</span><br><span class="line">    ObjectHelper.requireNonNull(d, <span class="string">"d is null"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!disposed) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!disposed) &#123;</span><br><span class="line">                OpenHashSet&lt;Disposable&gt; set = resources;</span><br><span class="line">                <span class="keyword">if</span> (set == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    set = <span class="keyword">new</span> OpenHashSet&lt;Disposable&gt;();</span><br><span class="line">                    resources = set;</span><br><span class="line">                &#125;</span><br><span class="line">                set.add(d);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    d.dispose();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在add一个disposable的时候，如果全局变量disposed为true，那么不会走if条件，而是直接走下面的<code>d.dispose();</code>这句，直接将监听的事件解除绑定。</p>
<p><strong>所有，CompositeDisposable的dispose()方法一定要放到Activity和Fragment生命周期结束的地方——onDestroy()中。</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/28/实现一个Handler-Looper框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/28/实现一个Handler-Looper框架/" itemprop="url">实现一个Handler-Looper框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-28T22:37:33+08:00">
                2019-08-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Handler的核心能力"><a href="#Handler的核心能力" class="headerlink" title="Handler的核心能力"></a>Handler的核心能力</h4><ul>
<li>线程间通信</li>
<li>延迟任务执行</li>
</ul>
<p><code>sendMessageDelayed(Message msg, long delay)</code></p>
<p><code>postDelayed(Runnable r, long delay)</code></p>
<h4 id="Looper的核心能力"><a href="#Looper的核心能力" class="headerlink" title="Looper的核心能力"></a>Looper的核心能力</h4><ul>
<li>Looper是线程特有的，所以要有ThreadLocal</li>
<li>包含MessageQueue</li>
<li><code>loop()</code>方法，在死循环中获取消息队列中的消息，分发给handler处理</li>
</ul>
<h4 id="MessageQueue的核心能力"><a href="#MessageQueue的核心能力" class="headerlink" title="MessageQueue的核心能力"></a>MessageQueue的核心能力</h4><ul>
<li>持有消息（链表）</li>
<li>消息按时间排序（优先队列）</li>
<li>队列为空的时候阻塞读取（阻塞队列）</li>
<li>头节点有延时可以定时阻塞（延时阻塞队列）</li>
</ul>
<p>使用DelayQueue</p>
<h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><p>仿造Android的message</p>
<hr>
<h3 id="类结构"><a href="#类结构" class="headerlink" title="类结构"></a>类结构</h3><p><img src="https://raw.githubusercontent.com/zhujiaqqq/daily-pic/master/img/20190828230220.png" alt></p>
<h3 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h3><ul>
<li><p>实现BlockingQueue接口（实现阻塞功能）</p>
</li>
<li><p>有PriorityQueue对象（可以优先排序）</p>
<p>DelayQueue的阻塞机制：通过condition.await方法</p>
</li>
</ul>
<h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><p>没有实现remove的方法</p>
<hr>
<h4 id="为什么Android不直接使用DelayQueue作为消息队列"><a href="#为什么Android不直接使用DelayQueue作为消息队列" class="headerlink" title="为什么Android不直接使用DelayQueue作为消息队列"></a>为什么Android不直接使用DelayQueue作为消息队列</h4><ul>
<li>DelayQueue没有提供合适的remove机制</li>
<li>更大的自由度，可以定制许多功能，特别是与Native层结合</li>
<li>Android的MessageQueue可以针对单线程读取的场景做优化，只有插入队列的时候加锁，而读取的时候不用加锁；DelayQueue读写都加锁</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/27/Android为什么非UI线程不能更新UI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/27/Android为什么非UI线程不能更新UI/" itemprop="url">Android为什么非UI线程不能更新UI</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-27T15:52:08+08:00">
                2019-08-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="UI-线程的什么"><a href="#UI-线程的什么" class="headerlink" title="UI 线程的什么"></a>UI 线程的什么</h4><p>Zygote fork出的线程就是UI线程。</p>
<p>zygote创建App的过程中调用ActivityThread类的main()方法，main中会自行<code>Looper.loop();</code>。</p>
<h4 id="主线程如何工作"><a href="#主线程如何工作" class="headerlink" title="主线程如何工作"></a>主线程如何工作</h4><ul>
<li>handler </li>
<li>loop </li>
<li>messageQueue</li>
</ul>
<h4 id="如果把UI设计成线程安全的"><a href="#如果把UI设计成线程安全的" class="headerlink" title="如果把UI设计成线程安全的"></a>如果把UI设计成线程安全的</h4><p>那么需要对控件加锁，哪一个线程拿到锁才能设置UI。</p>
<h4 id="UI为什么不设计成线程安全的"><a href="#UI为什么不设计成线程安全的" class="headerlink" title="UI为什么不设计成线程安全的"></a>UI为什么不设计成线程安全的</h4><ul>
<li>UI具有可变性，甚至是高频可变性</li>
<li>UI对响应时间的敏感性要求UI操作必须高效</li>
<li>UI组件必须批量绘制来保证效率</li>
</ul>
<p><em>加锁可以变成线程安全，但是加锁是有性能开销的，会使UI的整体性能下降</em></p>
<h4 id="非UI线程一定不能更新UI吗"><a href="#非UI线程一定不能更新UI吗" class="headerlink" title="非UI线程一定不能更新UI吗"></a>非UI线程一定不能更新UI吗</h4><p>SurfaceView可以在非UI线程更新UI：</p>
<p>lockCanvas -&gt; draw -&gt; unLockCanvasAndPost </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/25/如何实现类似微信右滑返回的效果/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhujiaqqq">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhujiaqqq Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/25/如何实现类似微信右滑返回的效果/" itemprop="url">如何实现类似微信右滑返回的效果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-25T16:14:43+08:00">
                2019-08-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Fragment的实现"><a href="#Fragment的实现" class="headerlink" title="Fragment的实现"></a>Fragment的实现</h4><ul>
<li>对于Fragment的控制相对简单</li>
<li>不涉及window的控制，只是View级别的操作</li>
<li>实现View跟随手势滑动移动的效果</li>
<li>实现手势结束后判断取消或返回执行归位动画</li>
</ul>
<h4 id="Activity的实现"><a href="#Activity的实现" class="headerlink" title="Activity的实现"></a>Activity的实现</h4><ul>
<li><p>处理好window的控制</p>
<ul>
<li><p>修改activity的style属性：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"AppTranslucentTheme"</span> <span class="attr">parent</span>=<span class="string">"AppTheme"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowBackground"</span>&gt;</span>@android:color/transparent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowIsTranslucent"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Activity联动（多个activity栈）</p>
<blockquote>
<p>Activity A和Activity C在Task#0</p>
</blockquote>
<p>  Activity B在Task#1</p>
<p>  当Activity A跳转Activity B时没有问题（有动画效果）</p>
<p>  再当Activity B跳转Activity C时，会先出现Activity A，然后动画效果到Activity C</p>
<p>处理方法：再Activity B跳转Activity C的时候将B页面整体截屏放到Activity C的下面。</p>
<p>获取Activity的栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Activity.java</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTaskId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ActivityManager.getService()</span><br><span class="line">            .getTaskForActivity(mToken, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Activity透明对生命周期的影响"><a href="#Activity透明对生命周期的影响" class="headerlink" title="Activity透明对生命周期的影响"></a>Activity透明对生命周期的影响</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">Created -- onStart --&gt; Started</span><br><span class="line">Started -- onResume --&gt; Resumed</span><br><span class="line">Resumed -- onPause --&gt;Started</span><br><span class="line">Started -- onStop --&gt; Created</span><br></pre></td></tr></table></figure>
<p>A、B、C、D四个Activity依次跳转，此时Activity栈中：A-&gt;B-&gt;C-&gt;D。（默认都不透明）</p>
<ul>
<li>如果D为不透明Activity，那么：D为Resumed状态（可操作），ABC为Created状态（不可见）。</li>
<li>如果D为透明Activity，那么：D为Resumed状态（可操作），C为Started状态（可见，不可操作），AB为Created状态（不可见）</li>
<li>如果C、D为透明Activity，那么：：D为Resumed状态（可操作），B、C为Started状态（可见，不可操作），A为Created状态（不可见）</li>
</ul>
<h4 id="实现滑动返回接口"><a href="#实现滑动返回接口" class="headerlink" title="实现滑动返回接口"></a>实现滑动返回接口</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zhujiaqqq</p>
              <p class="site-description motion-element" itemprop="description">Java Android Python Algorithm and Machine learning</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhujiaqqq</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
